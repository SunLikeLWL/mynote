# 11 | 编译提效：如何为 Webpack 编译阶段提速？


对于 Compiler 实例而言，耗时最长的显然是生成编译过程实例后的 make 阶段，
在这个阶段里，会执行模块编译到优化的完整过程。


而对于 Compilation 实例的工作流程来说，不同的项目和配置各有不同，
但总体而言，编译模块和后续优化阶段的生成产物并压缩代码的过程都是比较耗时的。





### 优化前的准备工作





#### 准备基于时间的分析工具：
我们需要一类插件，来帮助我们统计项目构建过程中在编译阶段的耗时情况，
这类工具可以是上一课中我们尝试手写的，也可以是使用第三方的工具。例如 speed-measure-webpack-plugin。

#### 准备基于产物内容的分析工具：
从产物内容着手分析是另一个可行的方式，因为从中我们可以找到对产物包体积影响最大的包的构成，
从而找到那些冗余的、可以被优化的依赖项。
通常，减少这些冗余的依赖包模块，不仅能减小最后的包体积大小，也能提升构建模块时的效率。
通常可以使用 webpack-bundle-analyzer 分析产物内容。



要提升这一阶段的构建效率，大致可以分为三个方向：

1、减少执行编译的模块。

2、提升单个模块构建的速度。

3、并行构建以提升总体效率。



### 减少执行构建的模块


#### IgnorePlugin

有的依赖包，除了项目所需的模块内容外，还会附带一些多余的模块。
可在构建模块时直接剔除那些需要被排除的模块，从而提升构建模块的速度，并减少产物体积




#### 按需引入类库模块


第二种典型的减少执行模块的方式是按需引入。

这种方式一般适用于工具类库性质的依赖包的优化，典型例子是 lodash 依赖包。

要解决这个问题，效果最佳的方式是在导入声明时只导入依赖包内的特定模块，这样就可以大大减少构建时间，以及产物的体积，如下图所示。


1、Tree Shaking 需要相应导入的依赖包使用 ES6 模块化，而 lodash 还是基于 CommonJS ，需要替换为 lodash-es 才能生效。

2、相应的操作是在优化阶段进行的，换句话说，Tree Shaking 并不能减少模块编译阶段的构建时间。




####  DllPlugin

DllPlugin 是另一类减少构建模块的方式，它的核心思想是将项目依赖的框架等模块单独构建打包，与普通构建流程区分开。


#### Externals


Webpack 配置中的 externals 和 DllPlugin 解决的是同一类问题：将依赖的框架等模块从构建过程中移除。它们的区别在于：


1、在 Webpack 的配置方面，externals 更简单，而 DllPlugin 需要独立的配置文件。

2、DllPlugin 包含了依赖包的独立构建流程，而 externals 配置中不包含依赖框架的生成方式，通常使用已传入 CDN 的依赖包。

3、externals 配置的依赖包需要单独指定依赖模块的加载方式：全局对象、CommonJS、AMD 等。

4、在引用依赖包的子模块时，DllPlugin 无须更改，而 externals 则会将子模块打入项目包中。





### 提升单个模块构建的速度

提升编译阶段效率的第二个方向，是在保持构建模块数量不变的情况下，提升单个模块构建的速度。
具体来说，是通过减少构建单个模块时的一些处理逻辑来提升速度。



#### include/exclude


Webpack 加载器配置中的 include/exclude，是常用的优化特定模块构建速度的方式之一。



#### noParse

Webpack 配置中的 module.noParse 则是在上述 include/exclude 的基础上，
进一步省略了使用默认 js 模块编译器进行编译的时间



#### Source Map

有条件也可以配合错误监控系统，将 Source Map 的构建和使用在线下监控后台中进行，以提升普通构建部署流程的速度。



#### TypeScript 编译优化

Webpack 中编译 TS 有两种方式：使用 ts-loader 或使用 babel-loader。

其中，在使用 ts-loader 时，由于 ts-loader 默认在编译前进行类型检查，因此编译时间往往比较慢， 



#### Resolve


Webpack 中的 resolve 配置制定的是在构建时指定查找模块文件的规则，例如：

1、resolve.modules：指定查找模块的目录范围。

2、resolve.extensions：指定查找模块的文件类型范围。

3、resolve.mainFields：指定查找模块的 package.json 中主文件的属性名。

4、resolve.symlinks：指定在查找模块时是否处理软连接。



### 并行构建以提升总体效率


#### HappyPack 与 thread-loader


这两种工具的本质作用相同，都作用于模块编译的 Loader 上，用于在特定 Loader 的编译过程中，以开启多进程的方式加速编译。



#### parallel-webpack


并发构建的第二种场景是针对与多配置构建。
Webpack 的配置文件可以是一个包含多个子配置对象的数组，
在执行这类多配置构建时，默认串行执行，而通过 parallel-webpack，就能实现相关配置的并行处理。



