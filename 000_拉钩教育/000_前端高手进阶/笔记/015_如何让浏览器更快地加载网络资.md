# 如何让浏览器更快地加载网络资


## 浏览器加载网络资源的速度


1、通过减少响应内容大小，比如使用 gzip 算法压缩响应体内容和 HTTP/2 的压缩头部功能；

2、通用也更为重要的技术就是使用缓存


### Web 缓存

按存储位置来区分


1、数据库缓存
2、服务端缓
3、CDN 缓存
4、浏览器缓存




### 浏览器缓存

1、HTTP

2、ServiceWorker



## HTTP缓存

HTTP 支持的缓存策略有两种：

1、强制缓存

2、协商缓存


### 强制缓存


强制缓存是在浏览器加载资源的时候，先直接从缓存中查找请求结果，
如果不存在该缓存结果，则直接向服务端发起请求。

1. Expires

HTTP/1.0 中可以使用响应头部字段 Expires 来设置缓存时间，它对应一个未来的时间戳


2. Cache-Control

no-cache，表示使用协商缓存，即每次使用缓存前必须向服务端确认缓存资源是否更新；

no-store，禁止浏览器以及所有中间缓存存储响应内容；

public，公有缓存，表示可以被代理服务器缓存，可以被多个用户共享；

private，私有缓存，不能被代理服务器缓存，不可以被多个用户共享；

max-age，以秒为单位的数值，表示缓存的有效时间；

must-revalidate，当缓存过期时，需要去服务端校验缓存的有效性。


###  协商缓存

协商缓存的更新策略是不再指定缓存的有效时间了，
而是浏览器直接发送请求到服务端进行确认缓存是否更新，
如果请求响应返回的 HTTP 状态为 304，则表示缓存仍然有效。
控制缓存的难题就是从浏览器端转移到了服务端。


1. Last-Modified 和 If-Modified-Since

服务端要判断缓存有没有过期，只能将双方的资源进行对比。



1、浏览器第一次请求资源，服务端在返回资源的响应头中加入 Last-Modified 字段，该字段表示这个资源在服务端上的最近修改时间；

2、当浏览器再次向服务端请求该资源时，请求头部带上之前服务端返回的修改时间，这个请求头叫 If-Modified-Since；

3、服务端再次收到请求，根据请求头 If-Modified-Since 的值，判断相关资源是否有变化，如果没有，则返回 304 Not Modified，并且不返回资源内容，浏览器使用资源缓存值；否则正常返回资源内容，且更新 Last-Modified 响应头内容。



存在两个问题：

1、精度问题，Last-Modified 的时间精度为秒，如果在 1 秒内发生修改，那么缓存判断可能会失效；

2、准度问题，考虑这样一种情况，如果一个文件被修改，然后又被还原，内容并没有发生变化，在这种情况下，浏览器的缓存还可以继续使用，但因为修改时间发生变化，也会重新返回重复的内容。


2. ETag 和 If-None-Match


1、浏览器第一次请求资源，服务端在返响应头中加入 Etag 字段，Etag 字段值为该资源的哈希值；

2、当浏览器再次跟服务端请求这个资源时，在请求头上加上 If-None-Match，值为之前响应头部字段 ETag 的值；

3、服务端再次收到请求，将请求头 If-None-Match 字段的值和响应资源的哈希值进行比对，如果两个值相同，则说明资源没有变化，返回 304 Not Modified；否则就正常返回资源内容，无论是否发生变化，都会将计算出的哈希值放入响应头部的 ETag 字段中。


存在两个问题：

1、计算成本

2、计算误差




## ServiceWorker


ServiceWorker 是浏览器在后台独立于网页运行的脚本，也可以这样理解，它是浏览器和服务端之间的代理服务器


ServiceWorker 非常强大，可以实现包括推送通知和后台同步等功能，更多功能还在进一步扩展，但其最主要的功能是实现离线缓存。


### 1. 使用限制

1、在 ServiceWorker 中无法直接访问 DOM，但可以通过 postMessage 接口发送的消息来与其控制的页面进行通信；

2、ServiceWorker 只能在本地环境下或 HTTPS 网站中使用；

3、ServiceWorker 有作用域的限制，一个 ServiceWorker 脚本只能作用于当前路径及其子路径；

4、由于 ServiceWorker 属于实验性功能，所以兼容性方面会存在一些问题，具体兼容情况请看下面的截图。



### 2. 使用方法

```js

if ('serviceWorker' in window.navigator) {
  window.navigator.serviceWorker
    .register('./sw.js')
    .then(console.log)
    .catch(console.error)
} else {
  console.warn('浏览器不支持 ServiceWorker!'

```




